<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('css'); ?>
</head>
<body>
  <div class="wrapper">
    <div id="header">
      <h1>マイページ</h1>
      <p id="user-name"><?= getUserName(userId); ?>さん</p>
    </div>
    <div class="main">
      <div class="events">
        <table>
          <tr>
            <th>日時</th>
            <th>内容</th>
            <th>申込状況</th>
          </tr>
          <? for (var i = 0; i < eventNum ; i++) { ?>
          <tr>
            <td><?= Utilities.formatDate(eventValues[i][1], 'Asia/Tokyo', 'yyyy年MM月dd日'); ?>
            </td>
            <td><?= eventValues[i][0]; ?></td>
            <td>
              <button type="submit" id="<?= 'entry' + String(i); ?>" value="<?= i; ?>" onclick="entry(this.value)">申込</button>
              <button type="submit" id="<?= 'cancel' + String(i); ?>" value="<?= i; ?>" onclick="cancel(this.value)">キャンセル</button>
            </td>
          </tr>
          <? } ?>
          <tr></tr>
        </table>
      </div>
      <input type="submit" onclick="jump(<?= getScriptUrl(1); ?>)" value="ログアウト">
    </div>
    <div id="footer">採用サイト 2020 模擬開発
    </div>
  </div>
</body>
<script>
  const userId = <?= userId ?>;
  const eventValues = <?= eventValues ?>;
  const eventNum = <?= eventNum ?>;

  // 申込・キャンセルボタンの初期設定
  window.onload = function () {
    for (let i = 0; i < eventNum; i++) {
      google.script.run
        .withFailureHandler(onFailure)
        .withSuccessHandler(onSuccess)
        .getStatus(userId, i);
    }
  };

  // ボタンのdisabled属性を指定し必要に応じてアラートを出す
  function onSuccess(result) {
    document.getElementById("entry" + String(result[0])).disabled = result[1];
    document.getElementById("cancel" + String(result[0])).disabled = result[2];
    if (result[3] != undefined) {
      alert(result[3]);
    }
  }

  // 申込ボタンを押下したとき
  function entry(eventId) {
    google.script.run
      .withFailureHandler(onFailure)
      .withSuccessHandler(onSuccess)
      .setEntry(userId, eventId);
  }

  // キャンセルボタンを押下したとき
  function cancel(eventId) {
    google.script.run
      .withFailureHandler(onFailure)
      .withSuccessHandler(onSuccess)
      .deleteEntry(userId, eventId);
  }

  function onFailure(e) {
    alert([e.message, e.stack]);
  }

  function jump(url) {
    window.top.location.href = url;
  }
</script>
</html>
